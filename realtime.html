<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Dizzi - Votação em Tempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .avatar-user {
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      transition: transform .15s;
    }
    .avatar-user:hover {
      transform: scale(1.08);
      border-color: #06b6d4;
    }
    .poll-card {
      background: linear-gradient(90deg, #e0f2fe 0%, #fff 100%);
    }
    .timeline-bar {
      background: linear-gradient(90deg, #06b6d4 0%, #38bdf8 100%);
    }
    .section-card {
      box-shadow: 0 2px 32px rgba(14,116,144,.04);
    }
    .section-title {
      letter-spacing: .02em;
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      background: #e0f2fe;
    }
    ::-webkit-scrollbar-thumb {
      background: #06b6d4;
      border-radius: 5px;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans min-h-screen">

  <!-- Header unificado -->
  <header class="bg-gray-900 text-white sticky top-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="text-2xl font-bold text-cyan-400">Dizzi</div>

        <!-- Menu Desktop -->
        <nav class="hidden md:flex space-x-8">
          <a href="/profile.html" class="hover:text-cyan-400 transition">Home</a>
          <a href="/create.html" class="hover:text-cyan-400 transition">Criar Votação</a>
          <a href="/vote.html" class="hover:text-cyan-400 transition">Votar</a>
          <a href="#" id="logoutLink" class="hover:text-red-400 transition">Sair</a>
        </nav>

        <!-- Botão Menu Mobile -->
        <div class="md:hidden">
          <button id="menu-toggle" class="text-2xl focus:outline-none">☰</button>
        </div>
      </div>
    </div>

    <!-- Menu Mobile -->
    <div id="mobile-menu" class="md:hidden hidden px-4 pb-4 bg-gray-900">
      <a href="/profile.html" class="block py-2 text-white hover:text-cyan-400">Início</a>
      <a href="/create.html" class="block py-2 text-white hover:text-cyan-400">Criar Votação</a>
      <a href="/vote.html" class="block py-2 text-white hover:text-cyan-400">Votar</a>
      <a href="#" id="logoutLinkMobile" class="block py-2 text-red-400 hover:text-red-300">Sair</a>
    </div>
  </header>

  <!-- Conteúdo principal -->
  <main class="max-w-4xl mx-auto p-6 space-y-8">

    <!-- Card da votação -->
    <div class="poll-card rounded-2xl shadow-lg py-6 px-8 flex flex-col md:flex-row items-center justify-between section-card mb-4">
      <div class="flex-1 md:mr-8">
        <h1 id="pollTitle" class="text-3xl md:text-4xl font-bold text-cyan-900 mb-2 section-title text-center md:text-left">
          Carregando eleição...
        </h1>
        <div class="flex flex-wrap gap-4 justify-center md:justify-start">
          <div class="flex flex-col items-center">
            <span class="text-xs text-gray-500">Total de Votos</span>
            <span class="text-2xl font-bold text-cyan-500" id="totalVotes">0</span>
          </div>
          <div class="flex flex-col items-center">
            <span class="text-xs text-gray-500">Código Ativo</span>
            <ul id="codes" class="flex gap-2 mt-1"></ul>
          </div>
        </div>
      </div>
      <div class="flex flex-col items-center mt-6 md:mt-0">
        <div class="text-xs text-gray-500">Última atualização</div>
        <div class="flex items-center timeline-bar rounded-full px-3 py-1 mt-1">
          <span id="timestamp-text" class="font-semibold text-white">--</span>
          <div class="ml-2 w-3 h-3 border-2 border-cyan-300 border-t-cyan-700 rounded-full animate-spin"></div>
        </div>
      </div>
    </div>

    <!-- Opções de Votação -->
    <section class="bg-white rounded-2xl section-card shadow p-6 mb-2">
      <h2 class="text-xl font-bold text-gray-800 mb-3 section-title">Opções de Votação</h2>
      <ul id="options" class="list-disc ml-8 text-gray-700 space-y-2"></ul>
    </section>

    <!-- Usuários que Votaram -->
    <section class="bg-white rounded-2xl section-card shadow p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4 section-title text-center">Usuários que Votaram</h2>
      <ul id="votedUsers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6"></ul>
    </section>
  </main>

  <!-- Scripts -->
  <script>
    // Toggle menu mobile
    const toggleBtn = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    toggleBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });

    // Elementos
    const pollTitleEl = document.getElementById('pollTitle');
    const totalVotesEl = document.getElementById('totalVotes');
    const codesEl = document.getElementById('codes');
    const optionsEl = document.getElementById('options');
    const votedUsersEl = document.getElementById('votedUsers');
    const timestampTextEl = document.getElementById('timestamp-text');

    // Pega o poll_id da URL
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('poll_id');
    if (id) console.log("ID da eleição: " + id);

    // Logout
    function handleLogout() {
      fetch('/app/Routes/api.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ action: 'logout' })
      })
      .then(res => res.json())
      .then(data => {
      if (data.success) window.location.href = 'login.html';
      else alert('Erro ao sair.');
      })
      .catch(() => alert('Erro ao sair.'));
    }

    document.getElementById("logoutLink")?.addEventListener("click", handleLogout);
    document.getElementById("logoutLinkMobile")?.addEventListener("click", handleLogout);

    // Conexão SSE
    const evtSource = new EventSource(`/app/Routes/realtime_poll_sse.php?poll_id=${id}`); // substitua pelo endpoint correto

    evtSource.onmessage = function (event) {
      const data = JSON.parse(event.data);
      if (data.error) {
        pollTitleEl.textContent = "Erro: " + data.error;
        return;
      }

      console.log("Dados recebidos via SSE:", data);

      pollTitleEl.textContent = data.poll_title;
      totalVotesEl.textContent = data.total_votes;

      updateCodes(codesEl, data.codes);
      updateList(optionsEl, data.options);
      updateVotedUsers(votedUsersEl, data.voted_users);

      timestampTextEl.textContent = utcToLocal(data.timestamp);
    };

    evtSource.onerror = function (err) {
      console.error("Erro SSE:", err);
    };

    // Função utilitária
    function updateCodes(container, codes) {
      container.innerHTML = '';
      codes.forEach(code => {
        const badge = document.createElement('span');
        badge.textContent = code;
        badge.className = "bg-cyan-500 text-white px-3 py-1 rounded-full text-sm font-semibold shadow mr-1";
        container.appendChild(badge);
      });
    }

    function updateList(container, items) {
      container.innerHTML = '';
      items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        li.className = "bg-cyan-50 px-4 py-2 rounded-lg font-medium shadow-sm";
        container.appendChild(li);
      });
    }

    function updateVotedUsers(container, users) {
      container.innerHTML = '';

      users.forEach(user => {
        const div = document.createElement('div');
        div.classList.add('flex', 'flex-col', 'items-center', 'justify-center', 'gap-2');

        // Imagem do perfil estilizada
        const img = document.createElement('img');
        img.src = user.profile_image || 'default-profile.png';
        img.alt = user.user_id;
        img.className = 'avatar-user w-16 h-16 rounded-full border-2 border-gray-200';

        // Nome do usuário estilizado
        const span = document.createElement('span');
        span.style.fontWeight = '600';
        span.style.fontSize = '1rem';
        span.textContent = user.user_id;
        span.className = 'text-gray-700 truncate text-center mt-1';

        div.appendChild(img);
        div.appendChild(span);
        container.appendChild(div);
      });

      // Se nenhum usuário votou
      if (users.length === 0) {
        container.innerHTML = `<div class="col-span-full text-center text-gray-400 py-6">Nenhum voto registrado ainda</div>`;
      }
    }

    /**
     * Converte uma string UTC (ISO ou "YYYY-MM-DD HH:MM:SS") para hora local
     * @param {string} utcDateTime - Data/hora em UTC
     * @param {string} [options] - opções de formatação (opcional)
     * @returns {string} - data/hora formatada em fuso local
     */
    function utcToLocal(utcDateTime, options = {}) {
      // Se receber formato 'YYYY-MM-DD HH:MM:SS', substitui espaço por T
      let utcString = utcDateTime.replace(' ', 'T') + 'Z'; // garante que é UTC
      const date = new Date(utcString);

      // Formato padrão: dd/mm/yyyy hh:mm:ss
      const defaultOptions = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      };

      return date.toLocaleString(undefined, { ...defaultOptions, ...options });
    }
  </script>

</body>

</html>