<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dizzi - Criar Votação</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">

  <!-- Header unificado -->
  <header class="bg-gray-900 text-white sticky top-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="text-2xl font-bold text-cyan-400">
          Dizzi
        </div>

        <!-- Menu Desktop -->
        <nav class="hidden md:flex space-x-8">
          <a href="index.html" class="hover:text-cyan-400 transition">Início</a>
          <a href="create.html" class="hover:text-cyan-400 transition">Criar Votação</a>
          <a href="vote.html" class="hover:text-cyan-400 transition">Votar</a>
          <a href="#" id="logoutLink" class="hover:text-red-400 transition">Sair</a>
        </nav>

        <!-- Botão Menu Mobile -->
        <div class="md:hidden">
          <button id="menu-toggle" class="text-2xl focus:outline-none">☰</button>
        </div>
      </div>
    </div>

    <!-- Menu Mobile -->
    <div id="mobile-menu" class="md:hidden hidden px-4 pb-4 bg-gray-900">
      <a href="index.html" class="block py-2 text-white hover:text-cyan-400">Início</a>
      <a href="create.html" class="block py-2 text-white hover:text-cyan-400">Criar Votação</a>
      <a href="vote.html" class="block py-2 text-white hover:text-cyan-400">Votar</a>
      <a href="#" id="logoutLinkMobile" class="block py-2 text-red-400 hover:text-red-300">Sair</a>
    </div>
  </header>

  <!-- Conteúdo -->
  <main class="flex items-center justify-center min-h-[80vh] px-4">
    <div class="w-full max-w-xl bg-white p-6 rounded-xl shadow-md">
      <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Criar Votação</h2>

      <input id="title" placeholder="Título da eleição"
        class="w-full p-3 mb-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400" />
      <textarea id="description" placeholder="Descrição"
        class="w-full p-3 mb-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400"></textarea>
      <input type="checkbox" onchange="setStateDuration(this)" id="set-timer" class="mr-2 mb-3">
      <label for="set-timer" class="mb-3">Definir duração? (em minutos)</label>
      <input id="duration" disabled placeholder="Duração em minutos" type="number" min="1"
        class="w-full p-3 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400" />

      <h3 class="text-lg font-semibold mb-2">Opções de Voto</h3>
      <div id="options" class="mb-3"></div>
      <button type="button" onclick="addOption()"
        class="mb-4 px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition">
        + Adicionar opção
      </button>

      <hr class="my-4">

      <button type="button" onclick="createElection()"
        class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        Criar Votação
      </button>

      <p id="message" class="bg-white-200 p-3 mt-4 rounded text-sm w-full text-center"></p>
    </div>
  </main>

  <script>
    // Habilita/desabilita o campo de duração
    function setStateDuration(checkbox) {
      document.getElementById("duration").disabled = !checkbox.checked;
      if (!checkbox.checked) document.getElementById("duration").value = '';
    }

    // Toggle menu mobile
    document.getElementById('menu-toggle').addEventListener('click', () => {
      document.getElementById('mobile-menu').classList.toggle('hidden');
    });

    // Funções pageshow, getCookie e loadUserData
    window.addEventListener("pageshow", async function () {
      const user = loadUserData();
      const payload = { action: "login", user_name: user, password: crypto.randomUUID() };
      try {
        const response = await fetch("/app/Routes/api.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload)
        });
        const raw = await response.text();
        let result;
        try { result = JSON.parse(raw); } catch { console.warn("⚠️ Resposta não JSON:", raw); return; }
        if (!result.success) window.location.href = "login.html";
      } catch (err) { console.error(err); }
    });

    function getCookie(name) {
      const cookies = document.cookie.split('; ');
      const cookie = cookies.find(c => c.startsWith(name + '='));
      return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
    }

    function loadUserData() {
      const userData = getCookie('user_data');
      if (!userData) return null;
      try { return JSON.parse(userData).userName; } catch { return null; }
    }

    function addOption(name = '') {
      const div = document.createElement("div");
      div.className = "option-field flex gap-2 items-center mb-2";
      div.innerHTML = `
        <input placeholder="Nome da opção" value="${name}" class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <button type="button" onclick="removeOption(this)" class="px-3 py-1 bg-red-200 text-white rounded-lg hover:bg-red-300 transition">❌</button>
      `;
      document.getElementById("options").appendChild(div);
    }

    function removeOption(btn) { btn.parentElement.remove(); }

    async function createElection() {
      const title = document.getElementById("title").value;
      const description = document.getElementById("description").value;
      const duration = document.getElementById("duration").value ?? null;
      const options = [...document.querySelectorAll("#options .option-field input")].map(i => i.value);
      const parsedData = JSON.parse(getCookie('user_data') || '{}');
      const payload = { action: "create_poll", user_id: parsedData.userName || '', title, description, duration, options };

      if (isNaN(duration) && duration.trim() === "") {
        payload.duration = null;
      }
      payload.duration = parseInt(payload.duration);
      
      try {
        const response = await fetch("/app/Routes/api.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload)
        });
        const raw = await response.text();
        console.log("Resposta criação votação:", raw);
        let data;
        try { data = JSON.parse(raw); } catch {
          document.getElementById("message").textContent = "⚠️ Resposta não JSON:\n" + raw;
          return;
        }
        if (data.success) {
          document.getElementById("message").textContent = "Votação criada com sucesso!";
        } else if (data.error) {
          let msg;
          if (data.error.code === "MALFORMED_REQUEST") {
            msg = "\nVerifique os dados informados.";
          } else if (data.error.code === "INTERNAL_SERVER_ERROR") {
            msg = "\nErro interno do servidor.";
          }
          document.getElementById("message").textContent = msg;
        } else {
          document.getElementById("message").textContent = "Erro desconhecido.";
        }
      } catch (err) {
        document.getElementById("message").textContent = "Erro na conexão com o servidor.";
        console.error(err);
      }
    }

    addOption();
    addOption();

    // Logout
    document.getElementById("logoutLink")?.addEventListener("click", async () => {
      try {
        const res = await fetch('/app/Routes/api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ action: 'logout' })
        });
        const data = await res.json();
        if (data.success) window.location.href = 'login.html';
        else alert('Erro ao sair.');
      } catch { alert('Erro ao sair.'); }
    });

    document.getElementById("logoutLinkMobile")?.addEventListener("click", async () => {
      try {
        const res = await fetch('/app/Routes/api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ action: 'logout' })
        });
        const data = await res.json();
        if (data.success) window.location.href = 'login.html';
        else alert('Erro ao sair.');
      } catch { alert('Erro ao sair.'); }
    });
  </script>

</body>

</html>