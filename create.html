<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Criar Eleição</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
        }

        button {
            padding: 10px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .option-field {
            display: flex;
            gap: 10px;
            margin: 5px 0;
        }

        .option-field input {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Criar Votação</h2>
        <input id="title" placeholder="Título da eleição">
        <textarea id="description" placeholder="Descrição"></textarea>
        <input id="duration" placeholder="Duração em ms">

        <h3>Opções de Voto</h3>
        <div id="options"></div>
        <button type="button" onclick="addOption()">+ Adicionar opção</button>

        <hr>
        <button type="button" onclick="createElection()">Criar Votação</button>
        <pre id="message" style="background:#eee; padding:10px;"></pre>
    </div>

    <script>
        window.addEventListener("pageshow", async function (event) {
            // Payload arbitrário para teste
            const payload = {
                action: "login",
                username: "usuario_teste",
                password: "senha_teste" 
            };

            try {
                const response = await fetch("https://localhost/app/Routes/api.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log(result);

                console.log(result)
                if (!result.success) {
                    window.location.href = "login.html";
                }

            } catch (error) {
                console.error("Erro na requisição:", error);
            }
        });

        function addOption(name = '') {
            const div = document.createElement("div");
            div.className = "option-field";
            div.innerHTML = `
                <input placeholder="Nome da opção" value="${name}">
                <input type="file" accept="image/*">
                <button type="button" onclick="removeOption(this)">❌</button>
            `;
            document.getElementById("options").appendChild(div);
        }

        function removeOption(btn) { btn.parentElement.remove(); }

        function getCookie(name) {
            const cookies = document.cookie.split('; ');
            const cookie = cookies.find(c => c.startsWith(name + '='));
            return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
        }

        async function createElection() {
            const title = document.getElementById("title").value;
            const description = document.getElementById("description").value;
            const duration = document.getElementById("duration").value;

            const optionFields = [...document.querySelectorAll("#options .option-field")];
            const formData = new FormData();

            const optionNames = optionFields.map((div, index) => {
                const name = div.querySelectorAll("input")[0].value;
                formData.append(`options[${index}][name]`, name);

                const fileInput = div.querySelectorAll("input")[1];
                if (fileInput.files[0]) {
                    formData.append(`options[${index}][image]`, fileInput.files[0]);
                }

                return name;
            });

            const userData = getCookie('user_data');
            const parsedData = JSON.parse(userData || '{}');
            formData.append('user_id', parsedData.userName || '');
            formData.append('title', title);
            formData.append('description', description);
            formData.append('duration', duration);

            try {
                const response = await fetch("https://localhost/app/Routes/api.php", {
                    method: "POST",
                    body: formData,
                    credentials: "include"
                });

                const data = await response.json();
                document.getElementById("message").textContent = "Resposta do servidor:\n" + JSON.stringify(data, null, 2);
            } catch (e) {
                document.getElementById("message").textContent = "Erro na conexão com o servidor.";
                console.error(e);
            }
        }

        // Começa com 2 opções vazias
        addOption();
        addOption();
    </script>
</body>

</html>